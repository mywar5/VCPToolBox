## VCP 4.5 AI日记全功能详解

## 创建和管理日记知识库

### 1. AI会主动调用`DailyNoteWrite`异步插件创建日记，如果创建成功，你将会在前端看到具体的日记气泡，VCP通知栏也会有具体的文件信息创建推送。该插件允许Agent为日记内容提供分类tag，从而构建不同类型日记本的归档入库。

所有日记以.txt/.MD格式保存在各自agent的主记忆区和知识分区，方便前端渲染和管理。后端服务器构建对等的对应维度向量化数据库。向量化数据库根据日记文件夹的哈希值变动精细化差分进行即时的向量化更新匹配，以保证数据库的双向一致性。日记文件构建强壮的多边同步机制。并且和rag数据库基于哈希值，时间戳和base64字段的原子级向量同步，用户改一个字，向量化就处理一那一句话。多重区块化RAG管理和备份，自动抗崩溃，内置数据库损毁自修复镜像，内置回溯数据库版本功能。
延申说明：通过多个Agent公用指定日记本的方式，不仅可以实现知识共享，还能实现多Agent协作时，毫秒级延迟的工作管线进度追踪。这是分布式多Agent协同的重要实现基础。

### 2. AI会主动调用`DailyNoteEdit`同步/异步插件来更新或者编辑单条已有日记，构建流畅的上下文记忆更新体验。

### 3. `DailyNoteManager`插件，这是一个强大的日记批处理插件，不推荐Agent自己操作该插件。建议使用VCP服务器内置的记忆大师Agent来操作该插件。只推荐Claude 4.5 Opus,Gemini 3 Pro,GPT 5 Ultra来驱动该Agent。避免低级模型语料污染高级模型。该插件会对Agent指定时间段内的日记进行批量操作，以进行事件合并，结构优化，语法去冗等复杂功能。

### 4. `DeepMemo`插件：三重混合检索，精准定位历史对话

`DeepMemo` 插件经过了重大升级，现在是一个强大的历史对话检索引擎，它允许 Agent 在过往的聊天记录中进行精确的块级搜索。其核心优势在于创新的**三重混合检索架构**，结合了多种算法的优点，以确保在任何场景下都能找到最相关的对话片段。

-   **第一层：`Fuse.js` 模糊搜索**
    -   **作用**：提供闪电般的**全文本模糊搜索**能力。
    -   **优势**：即使输入有错别字或不完全匹配，也能快速召回大量可能相关的对话块，保证了检索的广度。

-   **第二层：`BM25` 关键词加权**
    -   **作用**：采用经典的**BM25 算法**，根据关键词的稀有度和频率对第一层的结果进行排序。
    -   **优势**：能够快速识别出那些包含关键、稀有词汇的对话，提升了结果的相关性，擅长处理基于特定术语的查询。

-   **第三层：`Reranker` 语义精排**
    -   **作用**：将前两层筛选出的最佳结果，交给强大的**Reranker模型**进行最终的语义相关性排序。
    -   **优势**：它超越了关键词匹配，能真正理解查询的“意图”，并将语义上最贴近的对话片段排在最前面，确保了最终结果的最高质量。

通过这套“模糊召回 → 关键词加权 → 语义精排”的三重流水线，`DeepMemo` 插件能够在复杂的长对话历史中，精准、快速地定位到 Agent 所需的任何信息，无论是几个月前的一个约定，还是某个具体的技术细节。

### 5. `SGManager`插件，允许Agent管理所见知识库的词元组捕网关系结构。

## 数据库核心功能

VCP的RAG日记系统不仅仅是一个功能强大的信息检索工具，其背后还有一个经过深度优化的、高性能的向量数据库管理器 (`VectorDBManager.js`)。该管理器确保了日记内容的实时同步、高效检索和系统的长期稳定运行。

### 1. 高性能的HNSW索引

-   **核心技术**：采用业界领先的 `hnswlib-node` 库，基于HNSW（Hierarchical Navigable Small World）算法构建向量索引。
-   **优势**：即使在数百万级别的日记片段中，也能实现毫秒级的近似最近邻搜索，确保了RAG检索的极速响应。

### 2. 智能的增量与全量同步

-   **实时文件监控**：通过 `chokidar` 库7x24小时监控日记文件夹中的任何变动（增、删、改）。
-   **哈希校验**：系统会计算每个文件和文件内文本块（Chunk）的哈希值，并与存储在 `manifest.json` 中的记录进行比对。
-   **动态更新策略**：
    -   **微小变动**：如果只有少量日记内容变更，系统会执行**增量更新**，精确地添加、删除或修改对应的向量，资源消耗极低。可实现精准的句级原子操作。
    -   **巨大变动**：当检测到超过预设阈值（`changeThreshold`）的大规模内容变更时，系统会自动触发对整个日记本的**全量重建**，以保证索引的最佳性能和准确性。

### 3. 彻底的异步与多线程架构

-   **非阻塞设计**：为了防止CPU密集型任务（如文本向量化、索引构建）阻塞服务器主线程，所有核心处理流程都在独立的**Worker线程**中完成。
-   **独立工作单元**：
    -   `vectorizationWorker.js`: 负责在后台将日记文本批量转换为向量并构建索引文件。
    -   `vectorSearchWorker.js`: 每个搜索请求都会在一个独立的线程中执行，实现了搜索任务的完全隔离，互不干扰。

### 4. 精细化的内存管理与性能优化

-   **懒加载 (Lazy Loading)**：向量索引并不会在服务器启动时全部加载。只有当某个角色的日记本首次被查询时，其对应的索引文件 (`.bin`) 和数据映射文件 (`_map.json`) 才会被动态加载到内存中。
-   **LRU缓存淘汰机制**：系统会实时监控内存使用情况。当内存占用超过设定的最大值（`maxMemoryUsage`）时，会自动根据**最近最少使用 (LRU)** 算法，从内存中卸载不常用的索引，确保核心服务的稳定性。
-   **索引预热 (Pre-Warming)**：服务器会记录每个日记本的使用频率。在启动时，它会自动预先加载几个最常用的日记本索引，从而让高频查询的响应速度更快。
-   **查询结果缓存**：内置一个带TTL（生存时间）的LRU缓存，可以缓存最近的搜索结果。对于短时间内重复的或相似的查询，可以直接从缓存中返回结果，大幅降低计算开销。

### 5. 健壮性与可配置性

-   **API重试机制**：在调用外部Embedding API时，内置了带有指数退避策略的重试功能，能有效应对临时的网络波动或API服务不稳。
-   **高度可配置**：几乎所有核心参数，如更新阈值、内存限制、缓存大小、重试次数等，都可以通过环境变量进行配置，方便您根据不同的硬件环境和使用场景进行深度优化。

## 四种日记调用模式详解

根据您的具体需求，可以选择最合适的模式来调用日记内容：

### 1. `{{角色日记本}}` (服务器原生)

-   **工作模式**：**无条件全文注入**。
-   **描述**：这是服务器内置的、最基础的日记调用方式。一旦在System Prompt中检测到此语法，它会**无条件地**将指定角色的**所有**日记内容完整地注入到上下文中。
-   **适用场景**：当您需要角色完整回顾其所有记忆，或者需要对整个日记进行全面总结时。
-   **注意**：此模式不受本插件的任何智能检索逻辑控制。

### 2. `[[角色日记本]]` (插件)

-   **工作模式**：**无条件 RAG 片段检索**。
-   **描述**：此模式会忽略相似度判断，直接根据当前对话的上下文（根据话题复杂度的动态上下文与根据话题宽泛度的动态K值），从指定的日记向量数据库中检索出最相关的**记忆片段**。
-   **支持主动动态K值**：是。您可以使用 `[[角色日记本:1.5]]` 的语法来调整检索片段的数量（`1.5` 是一个乘数，会乘以插件动态计算出的基础K值）。
-   **适用场景**：当您明确知道需要根据当前话题从日记中寻找相关信息，但又不希望注入全部内容时。
-   **高级用法**：此模式支持强大的 **时间感知检索** 和 **语义组增强检索**，详见“高级功能与配置”部分。

### 3. `<<角色日记本>>` (插件)

-   **工作模式**：**基于相似度阈值的全文注入**。
-   **描述**：这是一种智能的全文注入模式。插件会首先计算当前对话上下文与该“日记本”主题（基于其名称和预设标签）的向量相似度。**只有当相似度超过预设的阈值时**，才会将该角色的**全部**日记内容注入。
-   **适用场景**：适用于那些不确定当前对话是否与某个角色的日记高度相关，希望由AI自动判断是否需要加载其完整背景故事的场合。例如<<小克工作ID日记本>>，<<VCP开发进度日记本>>，这种仅在需要的场景才会全程追踪的日记本。可以有效避免无关日记内容对上下文的污染。

### 4. `《《角色日记本》》` (插件) - **混合模式**

-   **工作模式**：**基于相似度阈值的 RAG 片段检索**。
-   **描述**：这是最智能、最灵活的模式，它结合了 `<<>>` 和 `[[]]` 的优点。它会先像 `<<>>` 模式一样进行相似度评估，**只有当相似度达标后**，才会像 `[[]]` 模式一样，去检索相关的**记忆片段**而非注入全文。
-   **支持动态K值**：是。同样支持 `《《角色日记本:1.5》》` 语法。
-   **适用场景**：大型日记库最推荐的日常使用模式。它既能通过阈值判断避免无关信息的干扰，又能在相关时只提取最关键的记忆片段，最大限度地保证了上下文的精确性和高效性。

---

## 高级功能与配置

### 动态K值

RAG检索的K值由用户发言的难度与AI话题的广度共同决定，并构建一个动态的上下文向量化窗口大小来作为匹配知识库的基础值。

对于 `[[]]` 和 `《《》》` 模式，您可以通过在末尾添加 `:乘数` 的方式来动态调整检索结果的数量。例如，`:1.5` 会将默认检索数量乘以1.5，而 `:0.5` 则会减半。这为您提供了更精细的控制。

### 标签 (Tags) 与阈值 (Threshold)

`<<>>` 和 `《《》》` 模式的相似度判断能力可以通过在 `rag_tags.json` 文件中设置标签和独立阈值来增强。

-   **Tags**: 您可以为每个日记本定义一组核心标签和权重（如 `"tags": ["战斗:1.2", "情感", "家庭:0.8"]`），插件会根据这些标签生成一个“增强向量”，使其能更准确地理解日记本的核心主题。
-   **Threshold**: 您可以为每个日记本设置一个独立的相似度阈值，覆盖全局默认值，以实现更精细的控制。

### 时间感知检索 (Time-Aware RAG) - 解决“我们上周聊了啥？”的利器

这是RAG日记插件最核心的创新之一，旨在解决RAG应用中最棘手的难题：**基于模糊时间概念的记忆回溯**。

-   **启用语法**：在 `[[]]` 模式后添加 `::Time` 标记 -> `[[角色日记本::Time]]`
-   **工作模式**：
    1.  当检测到 `::Time` 标记时，插件会激活**时间跨度拟合算法**。
    2.  它会智能解析用户最新发言中的所有自然语言时间描述（如“最近”、“上周五”、“三个月前”）。
    3.  **支持多时间点查询**：如果一句话中包含多个时间点（如“我和小克上周以及三个月前都聊了什么？”），插件会分别解析并合并所有时间范围的结果。
    4.  **智能去重**：算法会自动对解析出的时间范围和最终检索到的日记内容进行去重，确保结果的简洁性和唯一性。
    5.  **混合检索**：最终结果会智能融合“语义相关（RAG）”和“时间范围”两个维度的信息，提供最全面的上下文回溯。
-   **适用场景**：任何需要根据时间线索来回忆过去的对话场景。例如：
    -   “我们上周是不是讨论过VCP的更新计划？”
    -   “让我想想三个月前我在做什么。”
    -   “回顾一下我最近一周的工作进展。”

### 语义组增强检索 (Semantic Group RAG) - 向量域的逻辑捕网器

这是另一项核心创新，它允许你将零散的关键词组织成具有特定语义的“词组”，从而极大地提升检索的**可控性**和**准确性**。

-   **启用语法**：在 `[[]]` 模式后添加 `::Group` 标记 -> `[[角色日记本::Group]]`
-   **工作模式**：
    1.  当检测到 `::Group` 标记时，插件会激活**语义组管理器**。
    2.  它会分析用户发言，看是否命中了您在“语义组编辑器”中预设的任何词组的关键词向量网络。
    3.  如果命中，它会将原始查询向量与被激活的词组的“组向量”进行**加权融合**，生成一个全新的、语义更精确的“增强查询向量捕获网”。
    4.  最后，使用这个增强向量去数据库中进行检索。
-   **组合使用**：此功能可以和动态K值无缝结合，例如 `[[角色日记本:1.5::Group]]`。
-   **适用场景**：
    -   **逻辑串联**：传统RAG无法处理的事件线，关系树，逻辑串，轻松“一网打尽”。
    -   **精确控制主题**：当你希望检索聚焦于某个特定领域（如“编程”、“克苏鲁神话”）时，即使你的问题本身很宽泛，也能确保检索结果高度相关。
    -   **弥补向量短板**：当某些概念（如“愚者”、“世界”）在向量空间中距离较远，但逻辑上属于同一主题时，语义组可以强行将它们关联起来。
    -   **玩梗/黑话检索**：你可以为特定角色的“黑话”或“梗”创建一个语义组，让AI能听懂你们之间的特定语境。

### Rerank 精排检索 (Precision Ranking) - 召回系统的最后一块拼图

传统的向量检索（RAG）擅长从海量信息中快速“召回”一批可能相关的内容，但无法保证最相关的那条一定排在最前面。Rerank 技术正是为了解决这个问题而生，它为 VCP 的日记系统补上了“精确排序”这最后一块关键拼图。

-   **启用语法**：在 `[[]]` 或 `《《》》` 模式后添加 `::Rerank` 标记。
    -   `[[角色日记本::Rerank]]`
    -   `《《角色日记本:0.8::Rerank》》`
-   **工作模式**：
    1.  当检测到 `::Rerank` 标记时，插件首先会进行一次常规的向量检索，但会基于一个预设倍率的**超量获取**，以数倍于最终所需的结果（例如，需要5条，它会先获取10条）。
    2.  然后，它将用户的原始问题和这批初步结果打包，发送给一个更强大、更精细的**外部 Rerank 模型**。
    3.  这个高级模型会逐一评估每个初步结果与问题的真正“语义相关性”，并给出一个精确的分数。
    4.  最后，插件根据这个分数对结果进行**重新排序**，并将最顶尖、最相关的几条记忆片段注入到上下文中。
-   **优势**：极大地提升了检索结果的**准确性**。您会发现，AI 回忆起的往事不再是“沾边”而已，而是真正“命中核心”，让对话的连贯性和深度都得到质的飞跃。
-   **组合使用**：可以与动态K值、时间感知、语义组等所有功能无缝叠加，构建出极其强大的复合查询。例如：`[[小克日记本:1.2::Time::Group::Rerank]]`

---
## **三大自学习系统：让记忆更懂你**:
  - **RAG寻道自学习**: 系统会根据用户的交互记录（如采纳/忽略的结果）动态优化检索算法与路径，让高频、高效的“寻道”模式获得更高权重。
  - **Tag权重自学习**: 根据用户对不同主题内容的查询频率，自动、缓慢地调整日记本关联Tag的权重，使知识库的焦点能自动对齐用户的核心兴趣。
  - **词元组捕网系统自学习**: 监控用户的查询习惯，自动发现并建议将新的概念集，逻辑串或事件关联词汇纳入现有的语义组网络，实现知识网络的自我衍生与进化。该功能由完整强推理能力的御三家模型实现（Claude 4.5 Opus,Gemini 3 Pro,GPT 5 Ultra）。

通过这套层次化、高度智能的记忆与召回系统，VCP 为 AI Agent 提供了前所未有的大脑，使其能够根据不同场景和需求，灵活调用最合适的知识，从而表现出超凡的智能与适应性。突破了传统长记忆的三大高峰，时间维度模糊，事件顺序模糊和逻辑关联模糊，构建了真正抵达甚至超越人类的记忆系统，并实现了良好的上下文长度控制。

## 强烈建议：使用服务器管理面板

手动编辑 `rag_tags.json` 等多个权重、词元组文件可能比较复杂且容易出错。

我们强烈建议您使用服务器自带的管理面板来管理所有与日记相关的数据和配置。在管理面板中，您可以方便地：

-   **查看和编辑每个角色的日记内容**。
-   **为日记本添加、删除和调整带权重的标签 (Tags)**。
-   **为每个日记本独立设置相似度阈值 (Threshold)**。
-   **创建和编辑语义组 (Semantic Groups)**，为你的知识库添加更深层次的逻辑关联。
-   **监控所有日记知识库的向量化流程并进行调控**。

请访问您的服务器主页，通常可以在设置或插件管理区域找到相关入口。这将为您提供一个直观、高效的图形化界面来充分利用本插件的全部功能。
